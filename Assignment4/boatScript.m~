im1 = im2single(imread('img1.pgm'));
im2 = im2single(imread('img2.pgm'));
n = 10;
p = 10;

subplot(1, 2, 1);
imshow(im1, []);
title('im1');
subplot(1, 2, 2);
imshow(im2, []);
title('im2');

[ bestM, bestT ] = computeAffineTransformation(im1, im2, n, p);

% because we are going from 2 to 1
bestM = inv(bestM);
bestT = -bestT;

I = transformImage(im2, bestM, bestT);
%T = maketform('affine', [bestM(1,1), bestM(1,2); bestM(2,1), bestM(2,2); -bestT']);

figure, imshow(I);
title('Transformed im1');

figure, imshow(im2), hold on, imshow(I), hold off;

[im2t,xdataim2t,ydataim2t]=imtransform(im2,T);
% now xdataim2t and ydataim2t store the bounds of the transformed im2
xdataout=[min(1,xdataim2t(1)) max(size(im1,2),xdataim2t(2))];
ydataout=[min(1,ydataim2t(1)) max(size(im1,1),ydataim2t(2))];
% let's transform both images with the computed xdata and ydata
im2t=imtransform(im2,T,'XData',xdataout,'YData',ydataout);
im1t=imtransform(im1,maketform('affine',eye(3)),'XData',xdataout,'YData',ydataout);
 
